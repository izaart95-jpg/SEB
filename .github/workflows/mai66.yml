name: CHAT

on:
  workflow_dispatch:

jobs:
  chat-ngrok-runner:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      # ================= SSHX KEEP ALIVE =================
      - name: Start SSHX (keep alive)
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          $desktop = "$env:USERPROFILE\Desktop"
          echo "DESKTOP_DIR=$desktop" >> $env:GITHUB_ENV
          cd $desktop

          Invoke-WebRequest `
            -Uri "https://sshx.s3.amazonaws.com/sshx-x86_64-pc-windows-msvc.zip" `
            -OutFile "sshx.zip"

          Expand-Archive -Path "sshx.zip" -DestinationPath "." -Force
          Unblock-File "sshx.exe"

          echo "SSHX_EXE=$desktop\sshx.exe" >> $env:GITHUB_ENV

          $outFile = "$desktop\sshx_output.txt"
          echo "SSHX_OUT=$outFile" >> $env:GITHUB_ENV

          $sshxJob = Start-Job -ScriptBlock {
            param($exe, $out)
            & $exe *> $out
          } -ArgumentList "$desktop\sshx.exe", $outFile

          echo "SSHX_JOB_ID=$($sshxJob.Id)" >> $env:GITHUB_ENV

          Start-Sleep -Seconds 12

          $content = Get-Content $outFile -Raw
          $match = $content | Select-String -Pattern 'https://sshx\.io/s/\S+'

          Write-Host ""
          Write-Host "================ SSHX SESSION ================"
          if ($match) {
            $url = $match.Matches[0].Value
            Write-Host "SSHX LINK: $url"
            echo "SSHX_URL=$url" >> $env:GITHUB_ENV
          } else {
            Write-Host "SSHX link not detected"
            Write-Host $content
          }
          Write-Host "=============================================="
          Write-Host ""

      # ================= ORIGINAL STEPS =================
      - name: Prepare Downloads directory
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          $dl = "$env:USERPROFILE\Downloads\chat-work"
          New-Item -ItemType Directory -Force -Path $dl
          echo "WORK_DIR=$dl" >> $env:GITHUB_ENV

          $startTime = [DateTimeOffset]::UtcNow.ToUnixTimeSeconds()
          echo "START_TIME=$startTime" >> $env:GITHUB_ENV

      - name: Download and extract chat.tar
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          cd $env:WORK_DIR

          curl.exe --fail -L -o chat.tar `
            https://abstrusely-procompensation-phuong.ngrok-free.dev/chat.tar

          tar -xf chat.tar

      - name: Install npm dependencies
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          cd "$env:WORK_DIR\chat-main"
          npm install

      - name: Download ngrok.exe
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          cd $env:WORK_DIR

          curl.exe --fail -L -o ngrok.zip `
            https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip

          Expand-Archive ngrok.zip -Force
          $ngrok = Get-ChildItem -Recurse -Filter ngrok.exe | Select-Object -First 1
          echo "NGROK_EXE=$($ngrok.FullName)" >> $env:GITHUB_ENV

      - name: Configure ngrok auth
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          & "$env:NGROK_EXE" config add-authtoken 36kAMHU3fGiD51IZZ91dX7y9QWB_4xSjCmBjUCyD2137xtnKh

      - name: Run Node server and ngrok with timer
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          cd "$env:WORK_DIR\chat-main"

          $targetDuration = (5 * 60 + 50) * 60
          $startTime = [long]$env:START_TIME

          $job = Start-Job -ScriptBlock {
            param($dir)
            cd $dir
            node server.js
          } -ArgumentList "$env:WORK_DIR\chat-main"

          Start-Sleep -Seconds 5

          $ngrokJob = Start-Job -ScriptBlock {
            param($ngrokPath)
            & $ngrokPath http 9001 --log=stdout
          } -ArgumentList "$env:NGROK_EXE"

          Start-Sleep -Seconds 10

          while ($true) {
            $elapsed = ([DateTimeOffset]::UtcNow.ToUnixTimeSeconds() - $startTime)

            if ($elapsed -ge $targetDuration) {
              break
            }

            if ((Get-Job $job.Id).State -eq 'Failed' -or
                (Get-Job $ngrokJob.Id).State -eq 'Failed') {
              throw "Node or ngrok job failed"
            }

            Start-Sleep -Seconds 30
          }

      - name: Stop Node & ngrok and upload
        if: success()
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"

          Get-Process node -ErrorAction SilentlyContinue | Stop-Process -Force
          Get-Process ngrok -ErrorAction SilentlyContinue | Stop-Process -Force

          cd $env:WORK_DIR
          tar -cvf chat.tar chat-main

          curl.exe --fail -X POST `
            https://abstrusely-procompensation-phuong.ngrok-free.dev/delete

          Start-Sleep -Seconds 15

          curl.exe --fail -X POST -F `
            "file=@chat.tar" `
            https://abstrusely-procompensation-phuong.ngrok-free.dev/upload

          curl.exe --fail -X POST `
            https://illuminative-myriadly-ferdinand.ngrok-free.dev/trigger
