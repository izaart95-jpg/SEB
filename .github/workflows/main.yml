name: Parsec Auto Login
on:
  workflow_dispatch:

jobs:
  parsec:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Setup directory
        run: |
          $workDir = "D:\a\SEB\SEB\parsec"
          New-Item -ItemType Directory -Path $workDir -Force
          Set-Location $workDir
          echo "WORK_DIR=$workDir" >> $env:GITHUB_ENV
          Write-Host "Working in: $workDir"

      - name: Download and install Parsec
        run: |
          Write-Host "Downloading Parsec..."
          $parsecUrl = "https://builds.parsec.app/package/parsec-windows.exe"
          $parsecPath = "$env:WORK_DIR\parsec.exe"
          Invoke-WebRequest -Uri $parsecUrl -OutFile $parsecPath
          
          Write-Host "Installing Parsec silently..."
          Start-Process -FilePath $parsecPath -ArgumentList "/S" -Wait -NoNewWindow
          Start-Sleep -Seconds 10

      - name: Start Parsec
        run: |
          Write-Host "Starting Parsec..."
          
          $parsecExePath = "C:\Program Files\Parsec\parsecd.exe"
          if (Test-Path $parsecExePath) {
              Start-Process $parsecExePath
              Write-Host "Parsec started..."
          }
          
          Start-Sleep -Seconds 10

      - name: Simple Tab Login Method
        run: |
          Write-Host "=== SIMPLE TAB LOGIN METHOD ==="
          Write-Host "Using only Tab and Enter keys"
          
          # Wait for Parsec to be ready
          Start-Sleep -Seconds 3
          
          Add-Type -AssemblyName System.Windows.Forms
          
          # Step 1: Press Tab twice to get to email field
          Write-Host "Step 1: Pressing Tab twice to reach email field"
          [System.Windows.Forms.SendKeys]::SendWait("{TAB}")
          Start-Sleep -Seconds 1
          [System.Windows.Forms.SendKeys]::SendWait("{TAB}")
          Start-Sleep -Seconds 1
          
          # Step 2: Type email
          Write-Host "Step 2: Typing email: ffbewafa709@gmail.com"
          [System.Windows.Forms.SendKeys]::SendWait("ffbewafa709@gmail.com")
          Start-Sleep -Seconds 1
          
          # Step 3: Press Tab to go to password field
          Write-Host "Step 3: Pressing Tab to go to password field"
          [System.Windows.Forms.SendKeys]::SendWait("{TAB}")
          Start-Sleep -Seconds 1
          
          # Step 4: Type password
          Write-Host "Step 4: Typing password: Hamza@123456"
          [System.Windows.Forms.SendKeys]::SendWait("Hamza@123456")
          Start-Sleep -Seconds 1
          
          # Step 5: Press Tab to go to login button, then Enter
          Write-Host "Step 5: Pressing Tab then Enter to login"
          [System.Windows.Forms.SendKeys]::SendWait("{TAB}")
          Start-Sleep -Milliseconds 500
          [System.Windows.Forms.SendKeys]::SendWait("{ENTER}")
          Start-Sleep -Seconds 3
          
          Write-Host "Tab login method completed"

      - name: Alternative Tab Method
        run: |
          Write-Host "=== ALTERNATIVE TAB METHOD ==="
          Start-Sleep -Seconds 5
          
          Add-Type -AssemblyName System.Windows.Forms
          
          # Try a different Tab sequence
          Write-Host "Trying different Tab sequence..."
          
          # Press Tab 3 times to cycle through fields
          [System.Windows.Forms.SendKeys]::SendWait("{TAB}{TAB}{TAB}")
          Start-Sleep -Seconds 2
          
          # Clear and type email
          [System.Windows.Forms.SendKeys]::SendWait("^a{DELETE}ffbewafa709@gmail.com")
          Start-Sleep -Seconds 1
          
          # Tab to password
          [System.Windows.Forms.SendKeys]::SendWait("{TAB}")
          Start-Sleep -Seconds 1
          [System.Windows.Forms.SendKeys]::SendWait("Hamza@123456")
          Start-Sleep -Seconds 1
          
          # Tab to login and press Enter
          [System.Windows.Forms.SendKeys]::SendWait("{TAB}")
          Start-Sleep -Milliseconds 500
          [System.Windows.Forms.SendKeys]::SendWait("{ENTER}")
          Start-Sleep -Seconds 2

      - name: Take verification screenshots
        run: |
          Write-Host "=== TAKING VERIFICATION SCREENSHOTS ==="
          Start-Sleep -Seconds 8
          
          Add-Type -AssemblyName System.Windows.Forms
          Add-Type -AssemblyName System.Drawing
          
          $screen = [System.Windows.Forms.Screen]::PrimaryScreen
          $bounds = $screen.Bounds
          
          for ($i = 1; $i -le 5; $i++) {
              $bitmap = New-Object System.Drawing.Bitmap($bounds.Width, $bounds.Height)
              $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
              $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
              
              $bitmap.Save("$env:WORK_DIR\verify_$i.png", [System.Drawing.Imaging.ImageFormat]::Png)
              $graphics.Dispose()
              $bitmap.Dispose()
              
              Write-Host "Verification screenshot $i taken"
              Start-Sleep -Seconds 2
          }

      - name: Check Parsec status
        run: |
          Write-Host "=== CHECKING PARSEC STATUS ==="
          Start-Sleep -Seconds 5
          
          $parsecProcess = Get-Process | Where-Object { $_.ProcessName -like "*parsec*" }
          
          if ($parsecProcess) {
              Write-Host "✓ Parsec is running"
              $parsecProcess | Format-Table ProcessName, Id, MainWindowTitle -AutoSize
              
              # Check for successful login
              $mainWindow = $parsecProcess | Where-Object { 
                  $_.MainWindowTitle -ne "" -and 
                  $_.MainWindowTitle -notlike "*Sign*" -and 
                  $_.MainWindowTitle -notlike "*Login*" 
              }
              
              if ($mainWindow) {
                  Write-Host "✓ SUCCESS! Parsec is logged in"
              } else {
                  Write-Host "? Parsec running but might still be on login screen"
              }
          } else {
              Write-Host "✗ Parsec is NOT running"
          }

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: parsec-results
          path: D:\a\SEB\SEB\parsec\
          retention-days: 1
