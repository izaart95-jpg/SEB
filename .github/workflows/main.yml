name: Parsec Screenshot Debug
on:
  workflow_dispatch:

jobs:
  parsec-debug:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Setup workspace
        run: |
          Write-Host "Workspace: $env:GITHUB_WORKSPACE"
          mkdir -Force parsec-screenshots
          cd parsec-screenshots
          echo "WORK_DIR=$(Get-Location)" >> $env:GITHUB_ENV

      - name: Download reliable NirCmd
        run: |
          # Using a direct download from NirSoft
          $nircmdUrl = "https://www.nirsoft.net/utils/nircmd-x64.zip"
          $nircmdPath = "$env:WORK_DIR\nircmd.exe"
          
          # Download and extract
          $tempZip = "$env:TEMP\nircmd.zip"
          Invoke-WebRequest -Uri $nircmdUrl -OutFile $tempZip -UserAgent "Mozilla/5.0"
          Expand-Archive -Path $tempZip -DestinationPath "$env:TEMP\nircmd_temp" -Force
          
          # Find and copy nircmd.exe
          $foundExe = Get-ChildItem -Path "$env:TEMP\nircmd_temp" -Filter "nircmd.exe" -Recurse | Select-Object -First 1
          if ($foundExe) {
              Copy-Item -Path $foundExe.FullName -Destination $nircmdPath -Force
              Write-Host "NirCmd copied to: $nircmdPath"
              echo "NIRCMD_PATH=$nircmdPath" >> $env:GITHUB_ENV
          } else {
              Write-Host "NirCmd not found in archive, using alternative..."
              # Fallback to built-in PowerShell method
              echo "NIRCMD_PATH=PowerShell" >> $env:GITHUB_ENV
          }

      - name: Take test screenshots
        run: |
          Write-Host "=== Testing screenshot methods ==="
          
          # Method 1: Try NirCmd if available
          if ($env:NIRCMD_PATH -ne "PowerShell") {
              Write-Host "Testing NirCmd..."
              & "$env:NIRCMD_PATH" savescreenshotfull "test_nircmd.png"
          }
          
          # Method 2: PowerShell .NET (always works)
          Write-Host "Testing PowerShell method..."
          Add-Type -AssemblyName System.Windows.Forms
          Add-Type -AssemblyName System.Drawing
          
          $bounds = [System.Windows.Forms.Screen]::PrimaryScreen.Bounds
          $bitmap = New-Object System.Drawing.Bitmap($bounds.Width, $bounds.Height)
          $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
          $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
          $bitmap.Save("test_powershell.png", [System.Drawing.Imaging.ImageFormat]::Png)
          $graphics.Dispose()
          $bitmap.Dispose()
          
          # Show what we created
          Write-Host "Files created:"
          Get-ChildItem *.png

      - name: Download Parsec
        run: |
          Write-Host "Downloading Parsec..."
          $parsecUrl = "https://builds.parsec.app/package/parsec-windows.exe"
          $parsecPath = "$env:WORK_DIR\parsec.exe"
          Invoke-WebRequest -Uri $parsecUrl -OutFile $parsecPath
          Write-Host "Downloaded: $((Get-Item $parsecPath).Length / 1MB) MB"

      - name: Install Parsec
        run: |
          Write-Host "Installing Parsec..."
          # Try silent install
          Start-Process -FilePath "$env:WORK_DIR\parsec.exe" -ArgumentList "/S" -Wait -NoNewWindow
          Start-Sleep -Seconds 5

      - name: Take Parsec screenshots
        run: |
          Write-Host "Taking Parsec screenshots..."
          cd $env:WORK_DIR
          
          # Take 3 screenshots with PowerShell method
          for ($i = 1; $i -le 3; $i++) {
              Add-Type -AssemblyName System.Windows.Forms
              Add-Type -AssemblyName System.Drawing
              
              $bounds = [System.Windows.Forms.Screen]::PrimaryScreen.Bounds
              $bitmap = New-Object System.Drawing.Bitmap($bounds.Width, $bounds.Height)
              $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
              $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
              $bitmap.Save("parsec_$i.png", [System.Drawing.Imaging.ImageFormat]::Png)
              $graphics.Dispose()
              $bitmap.Dispose()
              
              Write-Host "Screenshot $i saved"
              Start-Sleep -Seconds 1
          }

      - name: List all files
        run: |
          Write-Host "=== ALL FILES ==="
          cd $env:WORK_DIR
          Get-ChildItem -Recurse | Format-Table Name, Length, LastWriteTime -AutoSize
          
          Write-Host "=== PNG FILES ==="
          $pngs = Get-ChildItem *.png
          Write-Host "Found $($pngs.Count) PNG files"
          $pngs | ForEach-Object { Write-Host "  - $_ ($($_.Length/1KB) KB)" }

      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        with:
          name: parsec-screenshots
          path: ${{ env.WORK_DIR }}/*.png
          if-no-files-found: error
          retention-days: 1

      - name: Upload everything
        uses: actions/upload-artifact@v4
        with:
          name: parsec-all-files
          path: ${{ env.WORK_DIR }}
          retention-days: 1
