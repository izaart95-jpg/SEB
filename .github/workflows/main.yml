name: Parsec Auto Login
on:
  workflow_dispatch:

jobs:
  parsec-login:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Setup directory
        run: |
          $workDir = "D:\a\SEB\SEB\parsec-login"
          New-Item -ItemType Directory -Path $workDir -Force
          Set-Location $workDir
          echo "WORK_DIR=$workDir" >> $env:GITHUB_ENV
          Write-Host "Working in: $workDir"

      - name: Install Parsec
        run: |
          Write-Host "Downloading Parsec..."
          $parsecUrl = "https://builds.parsec.app/package/parsec-windows.exe"
          $parsecPath = "$env:WORK_DIR\parsec.exe"
          Invoke-WebRequest -Uri $parsecUrl -OutFile $parsecPath
          
          Write-Host "Installing Parsec..."
          Start-Process -FilePath $parsecPath -ArgumentList "/S" -Wait -NoNewWindow
          Start-Sleep -Seconds 10

      - name: Take initial screenshot
        run: |
          Add-Type -AssemblyName System.Windows.Forms
          Add-Type -AssemblyName System.Drawing
          
          $screen = [System.Windows.Forms.Screen]::PrimaryScreen
          $bounds = $screen.Bounds
          $bitmap = New-Object System.Drawing.Bitmap($bounds.Width, $bounds.Height)
          $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
          $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
          $bitmap.Save("$env:WORK_DIR\initial.png", [System.Drawing.Imaging.ImageFormat]::Png)
          $graphics.Dispose()
          $bitmap.Dispose()
          Write-Host "Initial screenshot saved"

      - name: Start Parsec and take login screen
        run: |
          Write-Host "Starting Parsec..."
          # Launch Parsec
          Start-Process "C:\Program Files\Parsec\parsecd.exe" -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 5
          
          # Take screenshot
          Add-Type -AssemblyName System.Windows.Forms
          Add-Type -AssemblyName System.Drawing
          $screen = [System.Windows.Forms.Screen]::PrimaryScreen
          $bounds = $screen.Bounds
          $bitmap = New-Object System.Drawing.Bitmap($bounds.Width, $bounds.Height)
          $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
          $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
          $bitmap.Save("$env:WORK_DIR\login_screen.png", [System.Drawing.Imaging.ImageFormat]::Png)
          $graphics.Dispose()
          $bitmap.Dispose()

      - name: Download and install AutoHotkey
        run: |
          Write-Host "Downloading AutoHotkey..."
          $ahkUrl = "https://www.autohotkey.com/download/ahk-install.exe"
          $ahkPath = "$env:WORK_DIR\ahk-install.exe"
          Invoke-WebRequest -Uri $ahkUrl -OutFile $ahkPath
          
          Write-Host "Installing AutoHotkey..."
          Start-Process -FilePath $ahkPath -ArgumentList "/S" -Wait -NoNewWindow
          Start-Sleep -Seconds 5

      - name: Create and run login AHK script
        run: |
          Write-Host "Creating AHK login script..."
          
          # Create the AHK script file directly
          $ahkContent = @'
#NoEnv
SendMode Input
SetWorkingDir %A_ScriptDir%

; Wait for Parsec window
Sleep, 5000

; Take screenshot before login
Run, powershell -Command "Add-Type -AssemblyName System.Windows.Forms; Add-Type -AssemblyName System.Drawing; `$screen = [System.Windows.Forms.Screen]::PrimaryScreen; `$bounds = `$screen.Bounds; `$bitmap = New-Object System.Drawing.Bitmap(`$bounds.Width, `$bounds.Height); `$graphics = [System.Drawing.Graphics]::FromImage(`$bitmap); `$graphics.CopyFromScreen(`$bounds.Location, [System.Drawing.Point]::Empty, `$bounds.Size); `$bitmap.Save('$env:WORK_DIR\before_login.png', [System.Drawing.Imaging.ImageFormat]::Png); `$graphics.Dispose(); `$bitmap.Dispose()"

; Try to focus on Parsec window
WinActivate, Parsec
Sleep, 2000

; Click on approximate email field position (adjust these!)
Click, 500, 300
Sleep, 1000

; Type email
Send, ffbewafa709@gmail.com
Sleep, 1000

; Tab to password
Send, {Tab}
Sleep, 500

; Type password
Send, Hamza@123456
Sleep, 1000

; Screenshot with credentials
Run, powershell -Command "Add-Type -AssemblyName System.Windows.Forms; Add-Type -AssemblyName System.Drawing; `$screen = [System.Windows.Forms.Screen]::PrimaryScreen; `$bounds = `$screen.Bounds; `$bitmap = New-Object System.Drawing.Bitmap(`$bounds.Width, `$bounds.Height); `$graphics = [System.Drawing.Graphics]::FromImage(`$bitmap); `$graphics.CopyFromScreen(`$bounds.Location, [System.Drawing.Point]::Empty, `$bounds.Size); `$bitmap.Save('$env:WORK_DIR\credentials_entered.png', [System.Drawing.Imaging.ImageFormat]::Png); `$graphics.Dispose(); `$bitmap.Dispose()"

; Click login button (adjust coordinates!)
Click, 500, 400
Sleep, 3000

; Final screenshot
Run, powershell -Command "Add-Type -AssemblyName System.Windows.Forms; Add-Type -AssemblyName System.Drawing; `$screen = [System.Windows.Forms.Screen]::PrimaryScreen; `$bounds = `$screen.Bounds; `$bitmap = New-Object System.Drawing.Bitmap(`$bounds.Width, `$bounds.Height); `$graphics = [System.Drawing.Graphics]::FromImage(`$bitmap); `$graphics.CopyFromScreen(`$bounds.Location, [System.Drawing.Point]::Empty, `$bounds.Size); `$bitmap.Save('$env:WORK_DIR\after_login_click.png', [System.Drawing.Imaging.ImageFormat]::Png); `$graphics.Dispose(); `$bitmap.Dispose()"

Sleep, 5000
'@
          
          # Save to file
          $ahkPath = "$env:WORK_DIR\login.ahk"
          $ahkContent | Out-File -FilePath $ahkPath -Encoding UTF8
          
          # Run AHK script
          Write-Host "Running AHK script..."
          Start-Process "C:\Program Files\AutoHotkey\AutoHotkey.exe" -ArgumentList "`"$ahkPath`""
          Start-Sleep -Seconds 15

      - name: Wait for 2FA
        run: |
          Write-Host "=========================================="
          Write-Host "WAITING FOR 2FA - Check email"
          Write-Host "Waiting 60 seconds..."
          Write-Host "=========================================="
          Start-Sleep -Seconds 60
          
          # Screenshot after 2FA wait
          Add-Type -AssemblyName System.Windows.Forms
          Add-Type -AssemblyName System.Drawing
          $screen = [System.Windows.Forms.Screen]::PrimaryScreen
          $bounds = $screen.Bounds
          $bitmap = New-Object System.Drawing.Bitmap($bounds.Width, $bounds.Height)
          $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
          $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
          $bitmap.Save("$env:WORK_DIR\after_2fa_wait.png", [System.Drawing.Imaging.ImageFormat]::Png)
          $graphics.Dispose()
          $bitmap.Dispose()

      - name: Try to click Share button
        run: |
          Write-Host "Creating Share button AHK script..."
          
          $shareScript = @'
#NoEnv
SendMode Input
SetWorkingDir %A_ScriptDir%

Sleep, 3000

; Try different positions for Share button
; Top area
Click, 700, 100
Sleep, 1000

; Middle area
Click, 700, 300
Sleep, 1000

; Bottom area
Click, 700, 500
Sleep, 1000

; Take screenshot after clicks
Run, powershell -Command "Add-Type -AssemblyName System.Windows.Forms; Add-Type -AssemblyName System.Drawing; `$screen = [System.Windows.Forms.Screen]::PrimaryScreen; `$bounds = `$screen.Bounds; `$bitmap = New-Object System.Drawing.Bitmap(`$bounds.Width, `$bounds.Height); `$graphics = [System.Drawing.Graphics]::FromImage(`$bitmap); `$graphics.CopyFromScreen(`$bounds.Location, [System.Drawing.Point]::Empty, `$bounds.Size); `$bitmap.Save('$env:WORK_DIR\share_clicks.png', [System.Drawing.Imaging.ImageFormat]::Png); `$graphics.Dispose(); `$bitmap.Dispose()"

Sleep, 3000
'@
          
          $sharePath = "$env:WORK_DIR\share.ahk"
          $shareScript | Out-File -FilePath $sharePath -Encoding UTF8
          
          Start-Process "C:\Program Files\AutoHotkey\AutoHotkey.exe" -ArgumentList "`"$sharePath`""
          Start-Sleep -Seconds 10

      - name: Take final screenshots
        run: |
          Write-Host "Taking final screenshots..."
          for ($i = 1; $i -le 3; $i++) {
              Add-Type -AssemblyName System.Windows.Forms
              Add-Type -AssemblyName System.Drawing
              $screen = [System.Windows.Forms.Screen]::PrimaryScreen
              $bounds = $screen.Bounds
              $bitmap = New-Object System.Drawing.Bitmap($bounds.Width, $bounds.Height)
              $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
              $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
              $bitmap.Save("$env:WORK_DIR\final_$i.png", [System.Drawing.Imaging.ImageFormat]::Png)
              $graphics.Dispose()
              $bitmap.Dispose()
              Start-Sleep -Seconds 2
          }

      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        with:
          name: parsec-login-screenshots
          path: D:\a\SEB\SEB\parsec-login\*.png
          retention-days: 1

      - name: Upload all files
        uses: actions/upload-artifact@v4
        with:
          name: parsec-all-files
          path: D:\a\SEB\SEB\parsec-login\
          retention-days: 1
