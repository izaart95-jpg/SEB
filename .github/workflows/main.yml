name: Parsec Auto Login
on:
  workflow_dispatch:

jobs:
  parsec:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Setup directory
        run: |
          $workDir = "D:\a\SEB\SEB\parsec"
          New-Item -ItemType Directory -Path $workDir -Force
          Set-Location $workDir
          echo "WORK_DIR=$workDir" >> $env:GITHUB_ENV
          Write-Host "Working in: $workDir"

      - name: Download and install Parsec
        run: |
          Write-Host "Downloading Parsec..."
          $parsecUrl = "https://builds.parsec.app/package/parsec-windows.exe"
          $parsecPath = "$env:WORK_DIR\parsec.exe"
          Invoke-WebRequest -Uri $parsecUrl -OutFile $parsecPath
          
          Write-Host "Installing Parsec silently..."
          Start-Process -FilePath $parsecPath -ArgumentList "/S" -Wait -NoNewWindow
          Start-Sleep -Seconds 10

      - name: Start Parsec
        run: |
          Write-Host "Starting Parsec..."
          
          # Start Parsec
          $parsecExePath = "C:\Program Files\Parsec\parsecd.exe"
          if (Test-Path $parsecExePath) {
              Start-Process $parsecExePath
              Write-Host "Parsec started..."
          }
          
          Start-Sleep -Seconds 10

      - name: Take reference screenshot
        run: |
          Write-Host "Taking reference screenshot of login screen..."
          
          Add-Type -AssemblyName System.Windows.Forms
          Add-Type -AssemblyName System.Drawing
          $screen = [System.Windows.Forms.Screen]::PrimaryScreen
          $bounds = $screen.Bounds
          $bitmap = New-Object System.Drawing.Bitmap($bounds.Width, $bounds.Height)
          $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
          $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
          $bitmap.Save("$env:WORK_DIR\login_screen_reference.png", [System.Drawing.Imaging.ImageFormat]::Png)
          $graphics.Dispose()
          $bitmap.Dispose()
          
          Write-Host "Screen resolution: $($bounds.Width)x$($bounds.Height)")

      - name: Login with precise mouse coordinates
        run: |
          Write-Host "=== LOGIN WITH PRECISE MOUSE COORDINATES ==="
          
          # Get screen dimensions
          Add-Type -AssemblyName System.Windows.Forms
          $screen = [System.Windows.Forms.Screen]::PrimaryScreen
          $width = $screen.Bounds.Width
          $height = $screen.Bounds.Height
          
          Write-Host "Screen: ${width}x${height}"
          Write-Host "Assuming 1024x768 layout for coordinates..."
          
          # For typical Parsec login window at 1024x768:
          # Email field: ~512x300 (center, 300px from top)
          # Password field: ~512x350 (50px below email)
          # Login button: ~512x400 (50px below password)
          
          # Scale coordinates based on actual screen size
          $scaleX = $width / 1024
          $scaleY = $height / 768
          
          $emailX = [math]::Round(512 * $scaleX)
          $emailY = [math]::Round(300 * $scaleY)
          
          $passwordX = [math]::Round(512 * $scaleX)
          $passwordY = [math]::Round(350 * $scaleY)
          
          $loginX = [math]::Round(512 * $scaleX)
          $loginY = [math]::Round(400 * $scaleY)
          
          Write-Host "Calculated coordinates:"
          Write-Host "  Email: $emailX, $emailY"
          Write-Host "  Password: $passwordX, $passwordY"
          Write-Host "  Login: $loginX, $loginY"
          
          # Download AutoHotKey for more reliable input
          Write-Host "Downloading AutoHotKey for better input control..."
          $ahkUrl = "https://www.autohotkey.com/download/ahk.zip"
          $ahkPath = "$env:TEMP\ahk.zip"
          Invoke-WebRequest -Uri $ahkUrl -OutFile $ahkPath
          Expand-Archive -Path $ahkPath -DestinationPath "$env:TEMP\ahk" -Force
          
          # Create AutoHotKey script
          $ahkScript = @"
; AutoHotKey script for Parsec login
SetKeyDelay, 50, 50
SetMouseDelay, 50

; Wait for Parsec to be ready
Sleep, 3000

; CLICK EMAIL FIELD
MouseMove, $emailX, $emailY
Sleep, 500
Click
Sleep, 500
Click  ; Double click to select any existing text
Sleep, 500

; TYPE EMAIL
Send, {Ctrl Down}a{Ctrl Up}  ; Select all
Sleep, 200
Send, {Delete}  ; Clear field
Sleep, 500
SendRaw, ffbewafa709@gmail.com
Sleep, 1000

; CLICK PASSWORD FIELD
MouseMove, $passwordX, $passwordY
Sleep, 500
Click
Sleep, 500
Click  ; Double click
Sleep, 500

; TYPE PASSWORD
Send, {Ctrl Down}a{Ctrl Up}  ; Select all
Sleep, 200
Send, {Delete}  ; Clear field
Sleep, 500
SendRaw, Hamza@123456
Sleep, 1000

; CLICK LOGIN BUTTON
MouseMove, $loginX, $loginY
Sleep, 500
Click
Sleep, 500

; Wait and exit
Sleep, 3000
ExitApp
"@
          
          # Save and run AHK script
          $scriptPath = "$env:WORK_DIR\parsec_login.ahk"
          $ahkExePath = Get-ChildItem -Path "$env:TEMP\ahk" -Filter "AutoHotkey.exe" -Recurse | Select-Object -First 1
          
          if ($ahkExePath) {
              $ahkExePath = $ahkExePath.FullName
              Set-Content -Path $scriptPath -Value $ahkScript
              
              Write-Host "Running AutoHotKey script..."
              Start-Process -FilePath $ahkExePath -ArgumentList "`"$scriptPath`"" -Wait
              Write-Host "AutoHotKey script completed"
          } else {
              Write-Host "AutoHotKey not found, using PowerShell fallback..."
              
              # PowerShell fallback using nircmd
              if (Test-Path "$env:WORK_DIR\nircmd.exe") {
                  Write-Host "Using nircmd fallback..."
                  
                  # Click email field
                  & "$env:WORK_DIR\nircmd.exe" setcursor $emailX $emailY
                  Start-Sleep -Milliseconds 500
                  & "$env:WORK_DIR\nircmd.exe" sendmouse left dblclick
                  Start-Sleep -Seconds 1
                  
                  # Type email
                  Add-Type -AssemblyName System.Windows.Forms
                  [System.Windows.Forms.SendKeys]::SendWait("^a{DELETE}")
                  Start-Sleep -Milliseconds 500
                  [System.Windows.Forms.SendKeys]::SendWait("ffbewafa709@gmail.com")
                  Start-Sleep -Seconds 1
                  
                  # Click password field
                  & "$env:WORK_DIR\nircmd.exe" setcursor $passwordX $passwordY
                  Start-Sleep -Milliseconds 500
                  & "$env:WORK_DIR\nircmd.exe" sendmouse left dblclick
                  Start-Sleep -Seconds 1
                  
                  # Type password
                  [System.Windows.Forms.SendKeys]::SendWait("^a{DELETE}")
                  Start-Sleep -Milliseconds 500
                  [System.Windows.Forms.SendKeys]::SendWait("Hamza@123456")
                  Start-Sleep -Seconds 1
                  
                  # Click login button
                  & "$env:WORK_DIR\nircmd.exe" setcursor $loginX $loginY
                  Start-Sleep -Milliseconds 500
                  & "$env:WORK_DIR\nircmd.exe" sendmouse left click
                  Start-Sleep -Seconds 1
              }
          }
          
          Write-Host "Login attempt completed with mouse coordinates"

      - name: Alternative: Use PowerShell UI Automation
        run: |
          Write-Host "=== ALTERNATIVE: POWERSHELL UI AUTOMATION ==="
          Start-Sleep -Seconds 5
          
          # Try to find and interact with Parsec window using UI Automation
          # This is a backup method
          
          # Take screenshot to see current state
          Add-Type -AssemblyName System.Windows.Forms
          Add-Type -AssemblyName System.Drawing
          $screen = [System.Windows.Forms.Screen]::PrimaryScreen
          $bounds = $screen.Bounds
          $bitmap = New-Object System.Drawing.Bitmap($bounds.Width, $bounds.Height)
          $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
          $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
          $bitmap.Save("$env:WORK_DIR\after_ahk_attempt.png", [System.Drawing.Imaging.ImageFormat]::Png)
          $graphics.Dispose()
          $bitmap.Dispose()
          
          # Simple retry with different coordinates
          Write-Host "Trying different coordinates..."
          
          # Try clicking at different Y positions for email field
          $width = $bounds.Width
          $height = $bounds.Height
          
          # Higher up for email (Parsec window might be smaller)
          $emailY2 = [math]::Round($height * 0.4)  # 40% from top
          $passwordY2 = [math]::Round($height * 0.5)  # 50% from top
          $loginY2 = [math]::Round($height * 0.6)  # 60% from top
          $centerX = [math]::Round($width / 2)
          
          if (Test-Path "$env:WORK_DIR\nircmd.exe") {
              Write-Host "Trying alternative coordinates..."
              Write-Host "Email: $centerX, $emailY2"
              Write-Host "Password: $centerX, $passwordY2"
              Write-Host "Login: $centerX, $loginY2"
              
              # Click email
              & "$env:WORK_DIR\nircmd.exe" setcursor $centerX $emailY2
              Start-Sleep -Milliseconds 500
              & "$env:WORK_DIR\nircmd.exe" sendmouse left dblclick
              Start-Sleep -Seconds 1
              
              # Type email
              Add-Type -AssemblyName System.Windows.Forms
              [System.Windows.Forms.SendKeys]::SendWait("^a{DELETE}ffbewafa709@gmail.com")
              Start-Sleep -Seconds 1
              
              # Click password
              & "$env:WORK_DIR\nircmd.exe" setcursor $centerX $passwordY2
              Start-Sleep -Milliseconds 500
              & "$env:WORK_DIR\nircmd.exe" sendmouse left dblclick
              Start-Sleep -Seconds 1
              
              # Type password
              [System.Windows.Forms.SendKeys]::SendWait("^a{DELETE}Hamza@123456")
              Start-Sleep -Seconds 1
              
              # Click login
              & "$env:WORK_DIR\nircmd.exe" setcursor $centerX $loginY2
              Start-Sleep -Milliseconds 500
              & "$env:WORKORD\nircmd.exe" sendmouse left click
          }

      - name: Take verification screenshots
        run: |
          Write-Host "=== TAKING VERIFICATION SCREENSHOTS ==="
          Start-Sleep -Seconds 5
          
          # Take multiple screenshots
          for ($i = 1; $i -le 5; $i++) {
              Add-Type -AssemblyName System.Windows.Forms
              Add-Type -AssemblyName System.Drawing
              
              $screen = [System.Windows.Forms.Screen]::PrimaryScreen
              $bounds = $screen.Bounds
              $bitmap = New-Object System.Drawing.Bitmap($bounds.Width, $bounds.Height)
              $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
              $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
              
              $fileName = "verify_$i.png"
              $bitmap.Save("$env:WORK_DIR\$fileName", [System.Drawing.Imaging.ImageFormat]::Png)
              $graphics.Dispose()
              $bitmap.Dispose()
              
              Write-Host "Verification screenshot $i taken"
              Start-Sleep -Seconds 2
          }
          
          # Check Parsec status
          $parsecProcess = Get-Process | Where-Object { $_.ProcessName -like "*parsec*" }
          Write-Host "Parsec processes:"
          $parsecProcess | Format-Table ProcessName, Id, MainWindowTitle -AutoSize

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: parsec-results
          path: D:\a\SEB\SEB\parsec\
          retention-days: 1
