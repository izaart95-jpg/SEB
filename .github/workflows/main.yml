name: RustDesk with Screen Recording Permission

on:
  workflow_dispatch:

jobs:
  rustdesk-screenshots:
    runs-on: macos-latest
    timeout-minutes: 45

    steps:
      - name: Install RustDesk via Homebrew
        run: |
          echo "=== Installing RustDesk via Homebrew ==="
          if ! command -v brew &> /dev/null; then
            echo "Installing Homebrew..."
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
            echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zshrc
            eval "$(/opt/homebrew/bin/brew shellenv)"
          fi
          brew install --cask rustdesk
          echo "âœ… RustDesk installed via Homebrew"

      - name: Get Display Resolution
        run: |
          echo "=== Getting Display Resolution ==="
          RESOLUTION=$(osascript -e 'tell application "Finder" to get bounds of window of desktop' 2>/dev/null | awk -F', ' '{print $3 "x" $4}')
          if [ -z "$RESOLUTION" ] || [[ "$RESOLUTION" == "0x0" ]]; then
            RESOLUTION=$(system_profiler SPDisplaysDataType 2>/dev/null | grep -A1 "Resolution:" | tail -1 | tr -d ' ' | sed 's/[^0-9x]//g')
          fi
          if [ -z "$RESOLUTION" ] || [[ "$RESOLUTION" == "0x0" ]]; then
            RESOLUTION="1024x768"
          fi
          WIDTH=$(echo "$RESOLUTION" | cut -d'x' -f1)
          HEIGHT=$(echo "$RESOLUTION" | cut -d'x' -f2)
          echo "RESOLUTION=$RESOLUTION" >> $GITHUB_ENV
          echo "SCREEN_WIDTH=$WIDTH" >> $GITHUB_ENV
          echo "SCREEN_HEIGHT=$HEIGHT" >> $GITHUB_ENV
          mkdir -p screenshots
          echo "SCREENSHOT_DIR=$(pwd)/screenshots" >> $GITHUB_ENV

      - name: Start RustDesk
        run: |
          echo "=== Starting RustDesk ==="
          open -a /Applications/RustDesk.app
          sleep 15

      - name: Take Initial Screenshot
        run: |
          screencapture -x "$SCREENSHOT_DIR/before_permission.png"

      - name: Calculate Button Position
        run: |
          ORIGINAL_WIDTH=1024
          ORIGINAL_HEIGHT=768
          ORIGINAL_X=462
          ORIGINAL_Y=374
          X_SCALE=$(echo "scale=2; $SCREEN_WIDTH / $ORIGINAL_WIDTH" | bc)
          Y_SCALE=$(echo "scale=2; $SCREEN_HEIGHT / $ORIGINAL_HEIGHT" | bc)
          NEW_X=$(echo "$ORIGINAL_X * $X_SCALE" | bc | awk '{printf "%.0f"}')
          NEW_Y=$(echo "$ORIGINAL_Y * $Y_SCALE" | bc | awk '{printf "%.0f"}')
          echo "BUTTON_X=$NEW_X" >> $GITHUB_ENV
          echo "BUTTON_Y=$NEW_Y" >> $GITHUB_ENV

      - name: Click Allow Button
        run: |
          brew install cliclick
          screencapture -x "$SCREENSHOT_DIR/debug_before_click.png"
          cliclick c:$BUTTON_X,$BUTTON_Y
          sleep 3
          screencapture -x "$SCREENSHOT_DIR/debug_after_click.png"
          osascript <<'END_APPLESCRIPT'
tell application "System Events"
    delay 1
    click at {100, 100}
end tell
END_APPLESCRIPT

      - name: Take Verification Screenshots
        run: |
          for i in {1..5}; do
            screencapture -x "$SCREENSHOT_DIR/verify_$i.png"
            sleep 2
          done

      - name: Extra Clicks After Verification
        run: |
          brew install cliclick
          cliclick c:210,563
          sleep 2
          cliclick c:542,293
          sleep 2
          screencapture -x "$SCREENSHOT_DIR/extra_clicks.png"

      - name: Upload Extra Click Screenshot
        uses: actions/upload-artifact@v4
        with:
          name: extra-clicks
          path: ${{ env.SCREENSHOT_DIR }}/extra_clicks.png
          retention-days: 1

      - name: Keep System Running for 20 Minutes
        run: |
          for i in {1..20}; do
            echo "Minute $i"
            sleep 60
          done

      - name: Final Cleanup
        run: |
          screencapture -x "$SCREENSHOT_DIR/final.png"
          pkill -f RustDesk || true
