name: Parsec Auto Login
on:
  workflow_dispatch:

jobs:
  parsec:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Setup directory
        run: |
          $workDir = "D:\a\SEB\SEB\parsec"
          New-Item -ItemType Directory -Path $workDir -Force
          Set-Location $workDir
          echo "WORK_DIR=$workDir" >> $env:GITHUB_ENV
          Write-Host "Working in: $workDir"

      - name: Download and install Parsec
        run: |
          Write-Host "Downloading Parsec..."
          $parsecUrl = "https://builds.parsec.app/package/parsec-windows.exe"
          $parsecPath = "$env:WORK_DIR\parsec.exe"
          Invoke-WebRequest -Uri $parsecUrl -OutFile $parsecPath
          
          Write-Host "Installing Parsec silently..."
          Start-Process -FilePath $parsecPath -ArgumentList "/S" -Wait -NoNewWindow
          Start-Sleep -Seconds 10

      - name: Start Parsec
        run: |
          Write-Host "Starting Parsec..."
          
          # Start Parsec
          $parsecExePath = "C:\Program Files\Parsec\parsecd.exe"
          if (Test-Path $parsecExePath) {
              Start-Process $parsecExePath
              Write-Host "Parsec started..."
          }
          
          Start-Sleep -Seconds 10

      - name: Take reference screenshot
        run: |
          Write-Host "Taking reference screenshot of login screen..."
          
          Add-Type -AssemblyName System.Windows.Forms
          Add-Type -AssemblyName System.Drawing
          $screen = [System.Windows.Forms.Screen]::PrimaryScreen
          $bounds = $screen.Bounds
          $bitmap = New-Object System.Drawing.Bitmap($bounds.Width, $bounds.Height)
          $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
          $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
          $bitmap.Save("$env:WORK_DIR\login_screen_reference.png", [System.Drawing.Imaging.ImageFormat]::Png)
          $graphics.Dispose()
          $bitmap.Dispose()
          
          Write-Host "Screen resolution: $($bounds.Width)x$($bounds.Height)"

      - name: Login with precise mouse coordinates
        run: |
          Write-Host "=== LOGIN WITH PRECISE MOUSE COORDINATES ==="
          
          # Get screen dimensions
          Add-Type -AssemblyName System.Windows.Forms
          $screen = [System.Windows.Forms.Screen]::PrimaryScreen
          $width = $screen.Bounds.Width
          $height = $screen.Bounds.Height
          
          Write-Host "Screen: ${width}x${height}"
          Write-Host "Assuming 1024x768 layout for coordinates..."
          
          # Calculate coordinates
          $scaleX = $width / 1024
          $scaleY = $height / 768
          
          $emailX = [math]::Round(512 * $scaleX)
          $emailY = [math]::Round(300 * $scaleY)
          
          $passwordX = [math]::Round(512 * $scaleX)
          $passwordY = [math]::Round(350 * $scaleY)
          
          $loginX = [math]::Round(512 * $scaleX)
          $loginY = [math]::Round(400 * $scaleY)
          
          Write-Host "Calculated coordinates:"
          Write-Host "  Email: $emailX, $emailY"
          Write-Host "  Password: $passwordX, $passwordY"
          Write-Host "  Login: $loginX, $loginY"
          
          # Use nircmd for mouse control
          # Download nircmd if not already available
          if (-not (Test-Path "$env:WORK_DIR\nircmd.exe")) {
              Write-Host "Downloading nircmd..."
              $nircmdUrl = "https://www.nirsoft.net/utils/nircmd.zip"
              $zipPath = "$env:TEMP\nircmd.zip"
              Invoke-WebRequest -Uri $nircmdUrl -OutFile $zipPath
              Expand-Archive -Path $zipPath -DestinationPath "$env:TEMP\nircmd_extract" -Force
              $nircmdExe = Get-ChildItem -Path "$env:TEMP\nircmd_extract" -Filter "nircmd.exe" -Recurse | Select-Object -First 1
              if ($nircmdExe) {
                  Copy-Item -Path $nircmdExe.FullName -Destination "$env:WORK_DIR\nircmd.exe" -Force
              }
          }
          
          if (Test-Path "$env:WORK_DIR\nircmd.exe") {
              Write-Host "=== LOGIN SEQUENCE STARTING ==="
              
              # STEP 1: CLICK AND TYPE IN EMAIL FIELD
              Write-Host "Step 1: Clicking email field at $emailX, $emailY"
              & "$env:WORK_DIR\nircmd.exe" setcursor $emailX $emailY
              Start-Sleep -Milliseconds 500
              & "$env:WORK_DIR\nircmd.exe" sendmouse left dblclick
              Start-Sleep -Seconds 1
              
              # Type email
              Add-Type -AssemblyName System.Windows.Forms
              Write-Host "Typing email: ffbewafa709@gmail.com"
              [System.Windows.Forms.SendKeys]::SendWait("^a")  # Ctrl+A
              Start-Sleep -Milliseconds 200
              [System.Windows.Forms.SendKeys]::SendWait("{DELETE}")  # Delete
              Start-Sleep -Milliseconds 500
              [System.Windows.Forms.SendKeys]::SendWait("ffbewafa709@gmail.com")
              Start-Sleep -Seconds 1
              
              # Take screenshot after email
              Add-Type -AssemblyName System.Drawing
              $screen = [System.Windows.Forms.Screen]::PrimaryScreen
              $bounds = $screen.Bounds
              $bitmap = New-Object System.Drawing.Bitmap($bounds.Width, $bounds.Height)
              $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
              $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
              $bitmap.Save("$env:WORK_DIR\after_email.png", [System.Drawing.Imaging.ImageFormat]::Png)
              $graphics.Dispose()
              $bitmap.Dispose()
              
              # STEP 2: CLICK AND TYPE IN PASSWORD FIELD
              Write-Host "Step 2: Clicking password field at $passwordX, $passwordY"
              & "$env:WORK_DIR\nircmd.exe" setcursor $passwordX $passwordY
              Start-Sleep -Milliseconds 500
              & "$env:WORK_DIR\nircmd.exe" sendmouse left dblclick
              Start-Sleep -Seconds 1
              
              # Type password
              Write-Host "Typing password: Hamza@123456"
              [System.Windows.Forms.SendKeys]::SendWait("^a")  # Ctrl+A
              Start-Sleep -Milliseconds 200
              [System.Windows.Forms.SendKeys]::SendWait("{DELETE}")  # Delete
              Start-Sleep -Milliseconds 500
              [System.Windows.Forms.SendKeys]::SendWait("Hamza@123456")
              Start-Sleep -Seconds 1
              
              # Take screenshot after password
              $bitmap = New-Object System.Drawing.Bitmap($bounds.Width, $bounds.Height)
              $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
              $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
              $bitmap.Save("$env:WORK_DIR\after_password.png", [System.Drawing.Imaging.ImageFormat]::Png)
              $graphics.Dispose()
              $bitmap.Dispose()
              
              # STEP 3: CLICK LOGIN BUTTON
              Write-Host "Step 3: Clicking login button at $loginX, $loginY"
              & "$env:WORK_DIR\nircmd.exe" setcursor $loginX $loginY
              Start-Sleep -Milliseconds 500
              & "$env:WORK_DIR\nircmd.exe" sendmouse left click
              & "$env:WORK_DIR\nircmd.exe" sendmouse left click  # Double click to be sure
              Start-Sleep -Seconds 2
              
              Write-Host "=== LOGIN SEQUENCE COMPLETED ==="
              
          } else {
              Write-Host "ERROR: nircmd.exe not found!"
          }

      - name: Alternative coordinate method
        run: |
          Write-Host "=== ALTERNATIVE COORDINATE METHOD ==="
          Start-Sleep -Seconds 5
          
          # Try different Y coordinates in case the first attempt failed
          Add-Type -AssemblyName System.Windows.Forms
          $screen = [System.Windows.Forms.Screen]::PrimaryScreen
          $width = $screen.Bounds.Width
          $height = $screen.Bounds.Height
          
          Write-Host "Trying alternative coordinates..."
          
          # Alternative coordinates (higher on screen)
          $emailY_alt = [math]::Round($height * 0.35)  # 35% from top
          $passwordY_alt = [math]::Round($height * 0.45)  # 45% from top  
          $loginY_alt = [math]::Round($height * 0.55)  # 55% from top
          $centerX = [math]::Round($width / 2)
          
          Write-Host "Alternative coordinates:"
          Write-Host "  Email: $centerX, $emailY_alt"
          Write-Host "  Password: $centerX, $passwordY_alt"
          Write-Host "  Login: $centerX, $loginY_alt"
          
          if (Test-Path "$env:WORK_DIR\nircmd.exe") {
              # Try clicking at different spots in a grid pattern
              Write-Host "Trying grid search for fields..."
              
              # Define search grid
              $startY = [math]::Round($height * 0.3)  # Start at 30% from top
              $endY = [math]::Round($height * 0.6)    # End at 60% from top
              $step = 30  # 30 pixel steps
              
              for ($y = $startY; $y -le $endY; $y += $step) {
                  Write-Host "Clicking at $centerX, $y"
                  & "$env:WORK_DIR\nircmd.exe" setcursor $centerX $y
                  Start-Sleep -Milliseconds 300
                  & "$env:WORK_DIR\nircmd.exe" sendmouse left click
                  Start-Sleep -Milliseconds 300
                  
                  # Try typing something to see if we're in a field
                  Add-Type -AssemblyName System.Windows.Forms
                  [System.Windows.Forms.SendKeys]::SendWait("test")
                  Start-Sleep -Milliseconds 500
                  [System.Windows.Forms.SendKeys]::SendWait("{DELETE}{DELETE}{DELETE}{DELETE}")  # Clear
              }
              
              # Now try the actual login with best guess
              Write-Host "Trying login with best guess coordinates..."
              
              # Email field (assuming top field)
              & "$env:WORK_DIR\nircmd.exe" setcursor $centerX ($startY + 20)
              Start-Sleep -Milliseconds 500
              & "$env:WORK_DIR\nircmd.exe" sendmouse left dblclick
              Start-Sleep -Seconds 1
              [System.Windows.Forms.SendKeys]::SendWait("^a{DELETE}ffbewafa709@gmail.com")
              Start-Sleep -Seconds 1
              
              # Password field (assuming 50px below email)
              & "$env:WORK_DIR\nircmd.exe" setcursor $centerX ($startY + 70)
              Start-Sleep -Milliseconds 500
              & "$env:WORK_DIR\nircmd.exe" sendmouse left dblclick
              Start-Sleep -Seconds 1
              [System.Windows.Forms.SendKeys]::SendWait("^a{DELETE}Hamza@123456")
              Start-Sleep -Seconds 1
              
              # Login button (assuming 50px below password)
              & "$env:WORK_DIR\nircmd.exe" setcursor $centerX ($startY + 120)
              Start-Sleep -Milliseconds 500
              & "$env:WORK_DIR\nircmd.exe" sendmouse left click
          }

      - name: Take final verification screenshots
        run: |
          Write-Host "=== FINAL VERIFICATION ==="
          Start-Sleep -Seconds 8
          
          # Take multiple final screenshots
          for ($i = 1; $i -le 5; $i++) {
              Add-Type -AssemblyName System.Windows.Forms
              Add-Type -AssemblyName System.Drawing
              
              $screen = [System.Windows.Forms.Screen]::PrimaryScreen
              $bounds = $screen.Bounds
              $bitmap = New-Object System.Drawing.Bitmap($bounds.Width, $bounds.Height)
              $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
              $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
              
              $fileName = "final_check_$i.png"
              $bitmap.Save("$env:WORK_DIR\$fileName", [System.Drawing.Imaging.ImageFormat]::Png)
              $graphics.Dispose()
              $bitmap.Dispose()
              
              Write-Host "Final screenshot $i taken"
              Start-Sleep -Seconds 1
          }
          
          # Check Parsec status
          $parsecProcess = Get-Process | Where-Object { $_.ProcessName -like "*parsec*" }
          Write-Host "=== PARSEC STATUS ==="
          if ($parsecProcess) {
              Write-Host "✓ Parsec is running"
              $parsecProcess | Format-Table ProcessName, Id, MainWindowTitle -AutoSize
          } else {
              Write-Host "✗ Parsec is NOT running"
          }
          
          # List all files
          Write-Host "=== ALL FILES ==="
          Get-ChildItem -Path $env:WORK_DIR | Select-Object Name, Length, LastWriteTime | Format-Table -AutoSize

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: parsec-results
          path: D:\a\SEB\SEB\parsec\
          retention-days: 1
