name: Parsec Auto Login
on:
  workflow_dispatch:

jobs:
  parsec-login:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Setup directory
        run: |
          $workDir = "D:\a\SEB\SEB\parsec-login"
          New-Item -ItemType Directory -Path $workDir -Force
          Set-Location $workDir
          echo "WORK_DIR=$workDir" >> $env:GITHUB_ENV
          Write-Host "Working in: $workDir"

      - name: Install Parsec
        run: |
          Write-Host "Downloading Parsec..."
          $parsecUrl = "https://builds.parsec.app/package/parsec-windows.exe"
          $parsecPath = "$env:WORK_DIR\parsec.exe"
          Invoke-WebRequest -Uri $parsecUrl -OutFile $parsecPath
          
          Write-Host "Installing Parsec..."
          Start-Process -FilePath $parsecPath -ArgumentList "/S" -Wait -NoNewWindow
          Start-Sleep -Seconds 10

      - name: Take initial screenshot
        run: |
          Add-Type -AssemblyName System.Windows.Forms
          Add-Type -AssemblyName System.Drawing
          
          $screen = [System.Windows.Forms.Screen]::PrimaryScreen
          $bounds = $screen.Bounds
          $bitmap = New-Object System.Drawing.Bitmap($bounds.Width, $bounds.Height)
          $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
          $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
          $bitmap.Save("$env:WORK_DIR\initial.png", [System.Drawing.Imaging.ImageFormat]::Png)
          $graphics.Dispose()
          $bitmap.Dispose()
          Write-Host "Initial screenshot saved"

      - name: Start Parsec UI
        run: |
          Write-Host "Starting Parsec UI..."
          # Try to find and start Parsec
          $parsecPaths = @(
              "C:\Program Files\Parsec\parsecd.exe",
              "$env:LOCALAPPDATA\Parsec\parsecd.exe",
              "$env:APPDATA\Parsec\parsecd.exe"
          )
          
          foreach ($path in $parsecPaths) {
              if (Test-Path $path) {
                  Start-Process -FilePath $path
                  Write-Host "Started Parsec from: $path"
                  break
              }
          }
          Start-Sleep -Seconds 5

      - name: Take screenshot of login screen
        run: |
          Write-Host "Taking screenshot of login screen..."
          Add-Type -AssemblyName System.Windows.Forms
          Add-Type -AssemblyName System.Drawing
          
          $screen = [System.Windows.Forms.Screen]::PrimaryScreen
          $bounds = $screen.Bounds
          $bitmap = New-Object System.Drawing.Bitmap($bounds.Width, $bounds.Height)
          $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
          $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
          $bitmap.Save("$env:WORK_DIR\login_screen.png", [System.Drawing.Imaging.ImageFormat]::Png)
          $graphics.Dispose()
          $bitmap.Dispose()

      - name: Create AutoHotkey script for login
        run: |
          Write-Host "Creating AutoHotkey script..."
          # Save AHK script to file directly
          $ahkContent = @'
#NoEnv
SendMode Input
SetWorkingDir %A_ScriptDir%

; Wait for Parsec window
WinWait, Parsec, , 30
if ErrorLevel
{
    ; Take screenshot if window not found
    Run, powershell -Command "Add-Type -AssemblyName System.Windows.Forms; Add-Type -AssemblyName System.Drawing; `$screen = [System.Windows.Forms.Screen]::PrimaryScreen; `$bounds = `$screen.Bounds; `$bitmap = New-Object System.Drawing.Bitmap(`$bounds.Width, `$bounds.Height); `$graphics = [System.Drawing.Graphics]::FromImage(`$bitmap); `$graphics.CopyFromScreen(`$bounds.Location, [System.Drawing.Point]::Empty, `$bounds.Size); `$bitmap.Save('$env:WORK_DIR\no_window.png', [System.Drawing.Imaging.ImageFormat]::Png); `$graphics.Dispose(); `$bitmap.Dispose()"
    ExitApp
}

; Activate Parsec window
WinActivate, Parsec
WinWaitActive, Parsec, , 5
Sleep, 1000

; Take screenshot before login attempt
Run, powershell -Command "Add-Type -AssemblyName System.Windows.Forms; Add-Type -AssemblyName System.Drawing; `$screen = [System.Windows.Forms.Screen]::PrimaryScreen; `$bounds = `$screen.Bounds; `$bitmap = New-Object System.Drawing.Bitmap(`$bounds.Width, `$bounds.Height); `$graphics = [System.Drawing.Graphics]::FromImage(`$bitmap); `$graphics.CopyFromScreen(`$bounds.Location, [System.Drawing.Point]::Empty, `$bounds.Size); `$bitmap.Save('$env:WORK_DIR\before_login.png', [System.Drawing.Imaging.ImageFormat]::Png); `$graphics.Dispose(); `$bitmap.Dispose()"

; Try to click on email field
Sleep, 2000
Click, 500, 300  ; Adjust these coordinates based on screenshots!

; Type email
Send, ffbewafa709@gmail.com
Sleep, 1000

; Tab to password field
Send, {Tab}
Sleep, 500

; Type password
Send, Hamza@123456
Sleep, 1000

; Take screenshot with credentials entered
Run, powershell -Command "Add-Type -AssemblyName System.Windows.Forms; Add-Type -AssemblyName System.Drawing; `$screen = [System.Windows.Forms.Screen]::PrimaryScreen; `$bounds = `$screen.Bounds; `$bitmap = New-Object System.Drawing.Bitmap(`$bounds.Width, `$bounds.Height); `$graphics = [System.Drawing.Graphics]::FromImage(`$bitmap); `$graphics.CopyFromScreen(`$bounds.Location, [System.Drawing.Point]::Empty, `$bounds.Size); `$bitmap.Save('$env:WORK_DIR\credentials_entered.png', [System.Drawing.Imaging.ImageFormat]::Png); `$graphics.Dispose(); `$bitmap.Dispose()"

; Click login button
Sleep, 1000
Click, 500, 400  ; Adjust these coordinates based on screenshots!

; Wait and take final screenshot
Sleep, 5000
Run, powershell -Command "Add-Type -AssemblyName System.Windows.Forms; Add-Type -AssemblyName System.Drawing; `$screen = [System.Windows.Forms.Screen]::PrimaryScreen; `$bounds = `$screen.Bounds; `$bitmap = New-Object System.Drawing.Bitmap(`$bounds.Width, `$bounds.Height); `$graphics = [System.Drawing.Graphics]::FromImage(`$bitmap); `$graphics.CopyFromScreen(`$bounds.Location, [System.Drawing.Point]::Empty, `$bounds.Size); `$bitmap.Save('$env:WORK_DIR\after_login_click.png', [System.Drawing.Imaging.ImageFormat]::Png); `$graphics.Dispose(); `$bitmap.Dispose()"

Sleep, 3000
'@
          
          # Replace environment variable placeholder
          $ahkContent = $ahkContent.Replace('$env:WORK_DIR', $env:WORK_DIR)
          $ahkPath = "$env:WORK_DIR\login.ahk"
          $ahkContent | Out-File -FilePath $ahkPath -Encoding ASCII
          Write-Host "AHK script created: $ahkPath"

      - name: Install and run AutoHotkey
        run: |
          Write-Host "Downloading AutoHotkey..."
          $ahkInstaller = "$env:WORK_DIR\AutoHotkey_Setup.exe"
          Invoke-WebRequest -Uri "https://www.autohotkey.com/download/ahk-install.exe" -OutFile $ahkInstaller
          
          Write-Host "Installing AutoHotkey..."
          Start-Process -FilePath $ahkInstaller -ArgumentList "/S" -Wait -NoNewWindow
          Start-Sleep -Seconds 5
          
          Write-Host "Running AutoHotkey script..."
          $ahkExe = "C:\Program Files\AutoHotkey\AutoHotkey.exe"
          if (Test-Path $ahkExe) {
              Start-Process -FilePath $ahkExe -ArgumentList "$env:WORK_DIR\login.ahk"
              Start-Sleep -Seconds 15
          } else {
              Write-Host "AutoHotkey not found at: $ahkExe"
          }

      - name: Wait for 2FA
        run: |
          Write-Host "Waiting for 2FA code..."
          Write-Host "Check email: ffbewafa709@gmail.com"
          Start-Sleep -Seconds 90
          
          # Take screenshot after wait
          Add-Type -AssemblyName System.Windows.Forms
          Add-Type -AssemblyName System.Drawing
          $screen = [System.Windows.Forms.Screen]::PrimaryScreen
          $bounds = $screen.Bounds
          $bitmap = New-Object System.Drawing.Bitmap($bounds.Width, $bounds.Height)
          $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
          $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
          $bitmap.Save("$env:WORK_DIR\after_2fa_wait.png", [System.Drawing.Imaging.ImageFormat]::Png)
          $graphics.Dispose()
          $bitmap.Dispose()

      - name: Create share button script
        run: |
          Write-Host "Creating share button script..."
          $shareContent = @'
#NoEnv
SendMode Input
SetWorkingDir %A_ScriptDir%

; Wait a moment
Sleep, 5000

; Take screenshot
Run, powershell -Command "Add-Type -AssemblyName System.Windows.Forms; Add-Type -AssemblyName System.Drawing; `$screen = [System.Windows.Forms.Screen]::PrimaryScreen; `$bounds = `$screen.Bounds; `$bitmap = New-Object System.Drawing.Bitmap(`$bounds.Width, `$bounds.Height); `$graphics = [System.Drawing.Graphics]::FromImage(`$bitmap); `$graphics.CopyFromScreen(`$bounds.Location, [System.Drawing.Point]::Empty, `$bounds.Size); `$bitmap.Save('WORKDIR_PLACEHOLDER\ahk_share_attempt.png', [System.Drawing.Imaging.ImageFormat]::Png); `$graphics.Dispose(); `$bitmap.Dispose()"

; Try clicking at different positions
Click, 700, 100
Sleep, 1000

Click, 700, 300
Sleep, 1000

Click, 700, 500
Sleep, 1000

; Final screenshot
Run, powershell -Command "Add-Type -AssemblyName System.Windows.Forms; Add-Type -AssemblyName System.Drawing; `$screen = [System.Windows.Forms.Screen]::PrimaryScreen; `$bounds = `$screen.Bounds; `$bitmap = New-Object System.Drawing.Bitmap(`$bounds.Width, `$bounds.Height); `$graphics = [System.Drawing.Graphics]::FromImage(`$bitmap); `$graphics.CopyFromScreen(`$bounds.Location, [System.Drawing.Point]::Empty, `$bounds.Size); `$bitmap.Save('WORKDIR_PLACEHOLDER\after_share_clicks.png', [System.Drawing.Imaging.ImageFormat]::Png); `$graphics.Dispose(); `$bitmap.Dispose()"

Sleep, 3000
'@
          
          $shareContent = $shareContent.Replace('WORKDIR_PLACEHOLDER', $env:WORK_DIR)
          $sharePath = "$env:WORK_DIR\share.ahk"
          $shareContent | Out-File -FilePath $sharePath -Encoding ASCII
          
          # Run share script
          $ahkExe = "C:\Program Files\AutoHotkey\AutoHotkey.exe"
          if (Test-Path $ahkExe) {
              Start-Process -FilePath $ahkExe -ArgumentList $sharePath
              Start-Sleep -Seconds 10
          }

      - name: Take final screenshots
        run: |
          Write-Host "Taking final screenshots..."
          for ($i = 1; $i -le 3; $i++) {
              Add-Type -AssemblyName System.Windows.Forms
              Add-Type -AssemblyName System.Drawing
              $screen = [System.Windows.Forms.Screen]::PrimaryScreen
              $bounds = $screen.Bounds
              $bitmap = New-Object System.Drawing.Bitmap($bounds.Width, $bounds.Height)
              $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
              $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
              $bitmap.Save("$env:WORK_DIR\final_$i.png", [System.Drawing.Imaging.ImageFormat]::Png)
              $graphics.Dispose()
              $bitmap.Dispose()
              Start-Sleep -Seconds 2
          }

      - name: Upload all screenshots
        uses: actions/upload-artifact@v4
        with:
          name: parsec-login-screenshots
          path: D:\a\SEB\SEB\parsec-login\*.png
          retention-days: 1

      - name: Upload all files for debugging
        uses: actions/upload-artifact@v4
        with:
          name: parsec-login-all-files
          path: D:\a\SEB\SEB\parsec-login\
          retention-days: 1
